plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
    id 'com.google.devtools.ksp'
    id 'dagger.hilt.android.plugin'
}

android {
    namespace 'com.multisensor.recording'
    compileSdk 34

    defaultConfig {
        applicationId "com.multisensor.recording"
        minSdk 24
        targetSdk 34
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "com.multisensor.recording.CustomTestRunner"
        
        // NDK configuration for 16 KB page size compatibility
        ndk {
            // Ensure native libraries are built with proper alignment for 16 KB page sizes
            // This addresses the LOAD segments alignment issue for Google Play compliance
            abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64'
        }
    }

    packaging {
        resources {
            pickFirsts += "META-INF/LICENSE.md"
            pickFirsts += "META-INF/LICENSE-notice.md"
            // Exclude duplicate kotlinx-coroutines-core files
            excludes += "META-INF/kotlinx-coroutines-core.kotlin_module"
            // You can also exclude other common conflicting files
            // pickFirsts += "META-INF/NOTICE.md"
            // pickFirsts += "META-INF/DEPENDENCIES"
        }
        
        // 16 KB page size compatibility for native libraries
        jniLibs {
            // Ensure native libraries are properly aligned for 16 KB page sizes
            // This is required for Google Play compliance starting November 1st, 2025
            useLegacyPackaging = false
            // Keep native libraries compressed to ensure proper alignment
            keepDebugSymbols += "**/*.so"
        }
    }

    buildTypes {
        debug {
            debuggable true
            minifyEnabled false
            testCoverageEnabled true
            buildConfigField "String", "BUILD_TYPE", '"debug"'
        }
        
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            buildConfigField "String", "BUILD_TYPE", '"release"'
        }
        
        staging {
            initWith debug
            debuggable false
            buildConfigField "String", "BUILD_TYPE", '"staging"'
        }
    }
    
    flavorDimensions "environment"
    productFlavors {
        dev {
            dimension "environment"
            applicationIdSuffix ".dev"
            versionNameSuffix "-dev"
            buildConfigField "String", "ENVIRONMENT", '"development"'
        }
        
        prod {
            dimension "environment"
            buildConfigField "String", "ENVIRONMENT", '"production"'
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = '17'
    }
    
    buildFeatures {
        viewBinding true
        buildConfig true
    }
    
    // Additional build options for 16 KB page size compatibility
    buildTypes.configureEach {
        // Ensure native libraries are built with proper alignment
        // This helps address LOAD segment alignment issues for 16 KB page sizes
        ndk {
            debugSymbolLevel 'SYMBOL_TABLE'
        }
    }
    
    testOptions {
        unitTests {
            includeAndroidResources = true
            all {
                // JVM args and system properties are now configured in gradle.properties
                // for better environment portability
                systemProperty 'robolectric.logging.enabled', 'true'
            }
        }
    }
}

dependencies {
    // Core & UI Components
    implementation libs.bundles.core.ui
    
    // Architecture - Lifecycle, Coroutines, Permissions
    implementation libs.bundles.lifecycle
    implementation libs.kotlinx.coroutines.android
    implementation libs.bundles.activity.fragment
    
    // CameraX
    implementation libs.bundles.camera

    // Dependency Injection
    implementation libs.hilt.android
    ksp libs.hilt.compiler

    // Networking & Serialization
    implementation libs.bundles.networking

    // Unit Testing
    testImplementation libs.bundles.unit.testing
    
    // Hilt Testing
    testImplementation libs.hilt.android.testing
    kspTest libs.hilt.compiler

    // Android (Instrumented) Testing
    androidTestImplementation libs.bundles.integration.testing
    
    // Hilt Integration Testing
    androidTestImplementation libs.hilt.android.testing
    kspAndroidTest libs.hilt.compiler
    
    // TODO: Add Shimmer SDK dependency when available
    // TODO: Add Topdon thermal camera SDK dependency when available
}
